{% extends "base.html" %}
{% load static %}

{% block title %}{{ product.name }} | Shop Details{% endblock %}

{% block main %}

<div class="breadcrumb-area">
    <div class="top-breadcrumb-area bg-img bg-overlay d-flex align-items-center justify-content-center" style="background-image: url({% static 'img/bg-img/24.jpg' %});">
        <h2>Shop Details</h2>
    </div>
    <div class="container">
        <div class="row">
            <div class="col-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'index' %}"><i class="fa fa-home"></i> Home</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'shop' %}">Shop</a></li>
                        <li class="breadcrumb-item active" aria-current="page">{{ product.name }}</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
</div>
<section class="single_product_details_area mb-50">
    <div class="produts-details--content mb-50">
        <div class="container">
            <div class="row justify-content-between">

                <div class="col-12 col-md-6 col-lg-5">
                    <div class="product-gallery">
                        <div class="main-image-container">
                            <img id="main-product-image" 
                                 src="{% if product.images.all.0 %}{{ product.images.all.0.image.url }}{% else %}{% static 'img/no-image.png' %}{% endif %}" 
                                 alt="Main product image">
                        </div>
                        <div class="thumbnail-container d-flex mt-2">
                            {% for image in product.images.all %}
                                <div class="thumbnail-item">
                                    <img class="thumbnail-image" src="{{ image.image.url }}" alt="Product thumbnail {{ forloop.counter }}">
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="col-12 col-md-6">
                    <div class="single_product_desc">
                        <h4 class="title">{{ product.name }}</h4>
                        <div class="product-rating-details mb-3">
                            {% for i in "12345" %}<i class="fa fa-star{% if product.average_rating < i|add:'0' %}-o{% endif %}"></i>{% endfor %}
                            <a href="#reviews">({{ product.review_count }} Customer Reviews)</a>
                        </div>
                        <h4 class="price">₹{{ product.price|floatformat:2 }}</h4>
                        <div class="short_overview"><p>{{ product.description|linebreaks }}</p></div>
                        <div class="cart--area d-flex flex-wrap align-items-center">
                             {% if product.stock > 0 %}
                                <form class="cart clearfix d-flex align-items-center" method="post" action="{% url 'add_to_cart' product.id %}">
                                    {% csrf_token %}
                                    <div class="quantity">
                                        <span class="qty-minus" onclick="var e=document.getElementById('qty'),t=e.value;!isNaN(t)&&t>1&&e.value--;return!1"><i class="fa fa-minus"></i></span>
                                        <input type="number" class="qty-text" id="qty" step="1" min="1" max="{{ product.stock }}" name="quantity" value="1">
                                        <span class="qty-plus" onclick="var e=document.getElementById('qty'),t=e.value;!isNaN(t)&&e.value++;return!1"><i class="fa fa-plus"></i></span>
                                    </div>
                                    <button type="submit" name="addtocart" class="btn alazea-btn ml-15">Add to cart</button>
                                </form>
                            {% else %}
                                <p class="font-weight-bold text-danger">This product is currently out of stock.</p>
                            {% endif %}
                        </div>
                        <div class="products--meta"><p><span>Category:</span> {{ product.category.name }}</p></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<section class="customer-reviews-area section-padding-0-100" id="reviews">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12 col-lg-8">
                <div class="reviews-header">
                    <div class="review-title-area">
                        <h2>Customer Reviews</h2>
                        <div class="avg-rating-summary">
                            {% for i in "12345" %}<i class="fa fa-star{% if product.average_rating < i|add:'0' %}-o{% endif %}"></i>{% endfor %}
                            <span>{{ product.average_rating|floatformat:1 }} out of 5</span>
                        </div>
                    </div>
                    <div class="write-review-btn-area">
                        <button class="btn alazea-btn" type="button" data-toggle="collapse" data-target="#reviewFormCollapse" aria-expanded="false">
                            Write a Review
                        </button>
                    </div>
                </div>

                <div class="collapse" id="reviewFormCollapse">
                    <div class="submit-review-form-area mt-4 mb-4">
                        {% if user.is_authenticated %}
                            <form action="{% url 'shop_details' product.id %}" method="post">
                                {% csrf_token %}
                                <div class="form-group"><label>Your Rating</label><div class="interactive-stars"><i class="fa fa-star" data-value="1"></i><i class="fa fa-star" data-value="2"></i><i class="fa fa-star" data-value="3"></i><i class="fa fa-star" data-value="4"></i><i class="fa fa-star" data-value="5"></i></div><input type="hidden" name="rating" id="rating-input" value="5" required></div>
                                <div class="form-group"><label for="comments">Your Comment</label><textarea class="form-control" id="comments" name="comment" rows="5" placeholder="Share your thoughts..." required></textarea></div>
                                <button type="submit" class="btn alazea-btn">Submit Review</button>
                            </form>
                        {% else %}
                            <p>Please <a href="{% url 'login_view' %}?next={{ request.path }}">login to write a review</a>.</p>
                        {% endif %}
                    </div>
                </div>

                <div class="reviews-list">
                    {% for review in product.reviews.all %}
                    <div class="single-review-item">
                        <div class="reviewer-avatar">{{ review.user.full_name|first|upper }}</div>
                        <div class="review-content">
                            <div class="review-meta">
                                <span class="reviewer-name">{{ review.user.full_name }}</span>
                                <span class="review-date">{{ review.created_at|date:"F d, Y" }}</span>
                            </div>
                            <div class="review-rating">{% for i in "12345" %}<i class="fa fa-star{% if review.rating < i|add:'0' %}-o{% endif %}"></i>{% endfor %}</div>
                            <div class="review-comment"><p>{{ review.comment|linebreaks }}</p></div>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-center mt-4">This product has no reviews yet.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</section>
<div class="related-products-area">
    <div class="container">
        <div class="row">
            <div class="col-12"><div class="section-heading text-center"><h2>Related Products</h2></div></div>
        </div>
        <div class="row">
            {% for related in related_products %}
            <div class="col-12 col-sm-6 col-lg-3">
                <div class="single-product-area mb-100">
                    <div class="product-card">
                        <div class="product-image-container">
                            <a href="{% url 'shop_details' related.id %}">
                                {% if related.images.all.0 %}<img src="{{ related.images.all.0.image.url }}" alt="{{ related.name }}">{% else %}<img src="{% static 'img/no-image.png' %}" alt="No Image">{% endif %}
                            </a>
                        </div>
                        <div class="product-card-body">
                            <a href="{% url 'shop_details' related.id %}" class="product-name"><h5>{{ related.name }}</h5></a>
                            <div class="product-rating mb-2">
                                {% for i in "12345" %}<i class="fa fa-star{% if related.average_rating < i|add:'0' %}-o{% endif %}"></i>{% endfor %}
                                <span class="review-count">({{ related.review_count }})</span>
                            </div>
                            <p class="product-price">₹{{ related.price|floatformat:2 }}</p>
                            {% if related.stock > 0 %}
                                <form action="{% url 'add_to_cart' related.id %}" method="post">
                                    {% csrf_token %}<input type="hidden" name="quantity" value="1">
                                    <button type="submit" class="btn alazea-btn btn-sm w-100"><i class="fa fa-shopping-cart"></i> Add to Cart</button>
                                </form>
                            {% else %}
                                <button type="button" class="btn alazea-btn btn-sm w-100" disabled style="background-color: #a0a0a0; border-color: #a0a0a0;">Out of Stock</button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-12"><p class="text-center">No related products found.</p></div>
            {% endfor %}
        </div>
    </div>
</div>
<style>
    /* Gallery Styles */
    .main-image-container{border:1px solid #ebebeb;border-radius:5px;overflow:hidden}#main-product-image{width:100%;height:auto;max-height:500px;object-fit:cover}.thumbnail-container{gap:10px}.thumbnail-item{width:80px;height:80px;border:1px solid #ddd;border-radius:5px;overflow:hidden;cursor:pointer;opacity:.7;transition:opacity .2s ease,border-color .2s ease}.thumbnail-item:hover,.thumbnail-item.active{opacity:1;border-color:#70c745}.thumbnail-image{width:100%;height:100%;object-fit:cover}
    
    /* Modern Product Card Styles */
    .product-card { background: #ffffff; border: 1px solid #ebebeb; border-radius: 8px; overflow: hidden; transition: box-shadow 0.3s ease, transform 0.3s ease; display: flex; flex-direction: column; height: 100%; }
    .product-card:hover { box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); transform: translateY(-5px); }
    .product-image-container { height: 220px; overflow: hidden; }
    .product-image-container img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.4s ease; }
    .product-card:hover .product-image-container img { transform: scale(1.05); }
    .product-card-body { padding: 20px; text-align: center; flex-grow: 1; display: flex; flex-direction: column; }
    .product-name h5 { font-size: 1rem; font-weight: 600; margin-bottom: 10px; color: #2a2a2a; transition: color 0.3s ease; }
    .product-name:hover h5 { color: #70c745; }
    .product-rating { color: #f5a623; } .review-count { font-size: 0.8rem; color: #777; }
    .product-price { font-size: 1.1rem; font-weight: 700; color: #70c745; margin-bottom: 15px; margin-top: auto; }
    .product-card-body .btn { margin-top: 10px; }
    
    /* Review Section Styles */
    .reviews-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ebebeb; padding-bottom: 20px; margin-bottom: 30px; }
    .reviews-header h2 { margin-bottom: 0; }
    .avg-rating-summary { display: flex; align-items: center; gap: 10px; color: #777; }
    .avg-rating-summary .fa-star { color: #f5a623; }
    .single-review-item { display: flex; padding: 20px 0; border-bottom: 1px solid #f2f2f2; }
    .single-review-item:last-child { border-bottom: none; }
    .reviewer-avatar { width: 45px; height: 45px; background-color: #70c745; color: white; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-weight: bold; font-size: 1.2rem; margin-right: 20px; flex-shrink: 0; }
    .review-content { flex-grow: 1; }
    .reviewer-name { font-weight: 600; margin-right: 10px; }
    .review-date { font-size: 0.85rem; color: #999; }
    .review-rating { color: #f5a623; margin-top: 5px; }
    .review-comment { margin-top: 10px; }
    .interactive-stars { font-size: 1.5rem; color: #ccc; }
    .interactive-stars i { cursor: pointer; transition: color 0.2s ease; }
    .interactive-stars i.hover, .interactive-stars i.selected { color: #f5a623; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Image Gallery Logic
    const mainImage = document.getElementById('main-product-image');
    const thumbnails = document.querySelectorAll('.thumbnail-image');
    const thumbnailItems = document.querySelectorAll('.thumbnail-item');
    if (thumbnailItems.length > 0) { thumbnailItems[0].classList.add('active'); }
    thumbnails.forEach((thumbnail, index) => {
        thumbnail.addEventListener('click', function() {
            mainImage.src = this.src;
            thumbnailItems.forEach(item => item.classList.remove('active'));
            thumbnailItems[index].classList.add('active');
        });
    });

    // Interactive Star Rating Logic
    const stars = document.querySelectorAll('.interactive-stars i');
    const ratingInput = document.getElementById('rating-input');
    if (stars.length > 0) {
        stars.forEach(star => star.classList.add('selected'));
        stars.forEach(star => {
            star.addEventListener('mouseover', function() {
                stars.forEach(s => { s.classList.remove('hover'); s.classList.remove('selected'); });
                for (let i = 0; i < this.dataset.value; i++) { stars[i].classList.add('hover'); }
            });
            star.addEventListener('mouseout', function() {
                stars.forEach(s => s.classList.remove('hover'));
                for (let i = 0; i < ratingInput.value; i++) { stars[i].classList.add('selected'); }
            });
            star.addEventListener('click', function() {
                ratingInput.value = this.dataset.value;
                stars.forEach(s => s.classList.remove('selected'));
                for (let i = 0; i < ratingInput.value; i++) { stars[i].classList.add('selected'); }
            });
        });
    }
});
</script>

{% endblock %}